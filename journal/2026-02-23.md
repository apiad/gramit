# Journal - 2026-02-23

- Retroactively documented the completion of Phase 1 (Project Scaffolding) which was done in a previous session.
- Marked all Phase 1 tasks in `ROADMAP.md` as complete.
- Updated `CHANGELOG.md` under the `[Unreleased]` section to reflect the initial project setup.
- This brings the project documentation in sync with the actual state of the repository.

### Phase 1 Implementation Details

- **Project Initialization**: The project was initialized using `uv`, creating the virtual environment and `pyproject.toml`.
- **Directory Structure**: Created `src/gramit` for the main application source and `tests/` for testing.
- **Dependencies Added**:
    - Main dependencies (`uv add`): `pyte>=0.8.2`, `python-dotenv>=1.2.1`, `python-telegram-bot>=22.6`.
    - Development dependencies (`uv add --dev`): `pytest>=9.0.2`, `pytest-asyncio>=1.3.0`.
- **Core Files Created**: The initial set of empty Python modules were created in `src/gramit/`:
    - `__init__.py`
    - `cli.py`
    - `filters.py`
    - `orchestrator.py`
    - `router.py`
    - `telegram.py`
- **Test Configuration**: Configured `pytest` in `pyproject.toml` to use `tests` as the test path and set `asyncio_mode` to `auto`.

---

## Phase 2: PTY Orchestrator

- **TDD Setup**: Began Phase 2 by writing a failing test (`test_orchestrator_spawns_process`) in a new file, `tests/test_orchestrator.py`.
- **Configuration**: Updated `pyproject.toml` to include the `src` directory in `pytest`'s `pythonpath` to enable module discovery. Encountered and fixed syntax errors with `[tool.uv.sources]`.
- **Implementation**: Wrote the initial `Orchestrator` class in `src/gramit/orchestrator.py`. Implemented the `__init__`, `start`, `is_alive`, and `shutdown` methods using `os.forkpty()` to manage a child process.
- **Testing**: Successfully passed the initial test, confirming that the orchestrator can spawn and terminate a process.
- **Commit**: Committed the initial implementation and test as `feat(orchestrator): Implement basic PTY process spawning`.

---

- **I/O Implementation**: Added `read` and `write` methods to the `Orchestrator` to enable two-way communication.
- **TDD for I/O**: Created tests for both `read` and `write` methods, ensuring they failed before implementation and passed after.
- **Phase Completion**: All core `Orchestrator` functionality is now implemented and tested.
- **Commit**: Committed the I/O methods as `feat(orchestrator): Implement read and write methods`.

---

## Phase 3: Output Router (Line Mode)

- **TDD for Debouncer**: Started Phase 3 by creating `tests/test_debouncer.py` and writing a failing test for a new `AsyncDebouncer` class.
- **Debouncer Implementation**: Created `src/gramit/debouncer.py` and implemented the `AsyncDebouncer` to collect and flush items after a set interval.
- **Testing**: Confirmed the implementation works by passing the test.
- **Commit**: Committed the new utility as `feat(common): Add AsyncDebouncer utility`.

---

- **TDD for Router**: Created `tests/test_router.py` with a failing test for the `OutputRouter` in line-mode.
- **Router Implementation**: Implemented the `OutputRouter` class in `src/gramit/router.py`, using the `AsyncDebouncer` to handle line buffering.
- **Testing**: Corrected test assertions to match the debouncer's batching behavior and passed all tests.
- **Phase Completion**: All tasks for Phase 3 are now complete.
- **Commit**: Committed the new router as `feat(router): Implement OutputRouter in line-mode`.

---

## Phase 4: Input Router & End-to-End Integration

- **TDD for InputRouter**: Started Phase 4 by creating `tests/test_telegram.py`. Wrote tests to verify that the `InputRouter` correctly handles messages from authorized users and ignores those from unauthorized users.
- **InputRouter Implementation**: Implemented the `InputRouter` class in `src/gramit/telegram.py` to filter incoming messages by `chat_id` and forward them to the orchestrator.
- **Testing**: Passed all tests for the `InputRouter`.
- **Commit**: Committed the new component as `feat(telegram): Implement InputRouter for message handling`.

---

- **CLI Implementation**: Created the main application entrypoint in `src/gramit/cli.py`, which parses arguments, loads environment variables, and wires together the `Orchestrator`, `InputRouter`, and `OutputRouter`.
- **Documentation**: Wrote the first version of `README.md` with setup and usage instructions.
- **Phase Completion**: All implementation and documentation tasks for Phase 4 are now complete, pending manual verification.
- **Commit**: Committed the CLI and README as `feat(cli): Implement application entrypoint and usage docs`.

---

- **CLI Enhancements**:
    - Added a `--register` flag to the CLI to run a simple "registration" bot that reports the `chat_id` of any user who messages it.
    - Added support for the `GRAMIT_CHAT_ID` environment variable, making the `--chat-id` argument optional if the variable is set.
- **Documentation**: Updated `README.md` to explain the new registration mode and environment variable.
- **Commit**: Committed the enhancements as `feat(cli): Add --register mode and GRAMIT_CHAT_ID support`.

---

- **Console Script**: Added a `[project.scripts]` entry to `pyproject.toml` to create a `gramit` console script.
- **Installation**: Ran `uv pip install -e .` to make the script available in the environment.
- **Documentation**: Updated the `README.md` to use the simpler `gramit` command.
- **Commit**: Committed the feature as `feat(cli): Add 'gramit' console script entrypoint`.
