# 2026-02-23: Mirror Mode and TUI Stability Fixes

## Status
- [x] Reproduced `TypeError` in `OutputRouter` when handling PTY bytes.
- [x] Fixed `bytes` vs `str` handling in `OutputRouter._handle_new_data`.
- [x] Optimized local input reading to handle chunks (improving TUI responsiveness).
- [x] Increased mirror debounce to 40ms to mitigate flickering.
- [x] Made terminal preparation/restoration more robust against non-TTY environments.
- [x] Verified with unit tests and regression tests.

## Observations
- The previous implementation of `OutputRouter` was incorrectly assuming that data from `Orchestrator.read()` (which returns `bytes`) could be directly concatenated to a string buffer.
- Reading local stdin one byte at a time was a major bottleneck for TUI applications, especially when mouse tracking was enabled.
- Mixing `sys.stdout.write` (buffered) with `os.write` (unbuffered) in the same terminal session was likely contributing to inconsistent rendering and flickering.

## Changes
- **src/gramit/router.py**:
    - Changed `_mirror_buffer` to `bytes`.
    - Updated `_handle_new_data` to handle both `str` and `bytes` inputs.
    - Optimized `_handle_local_input` to read up to 4096 bytes at once.
    - Increased `_mirror_debounce_interval` to 40ms.
    - Updated `_prepare_terminal` and `_restore_terminal` to use `os.write` and handle `io.UnsupportedOperation`.
- **tests/test_orchestrator.py**: Updated to expect `bytes` from `read()`.
- **tests/test_router_mirror_bytes.py**: Added reproduction test case.

## Next Steps
- Monitor for any further TUI flickering reports.
- Prepare for v0.4.4 release.
