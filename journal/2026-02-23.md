# Journal - 2026-02-23

## Summary of Activities
Today was a major push for security, stability, and the implementation of the "External Output Streaming" feature. We transitioned from a complex TUI-scraping design to a more robust side-log tailing approach, while significantly improving the terminal interaction experience.

## Detailed Log

### 1. Security Audit & Hardening
- **Vulnerability Discovery:** Performed a full security audit. Identified a world-readable `.env` file and an exposed (though ignored) Telegram token.
- **Permission Fix:** Restricted `.env` permissions to `600` (owner-only).
- **Documentation:** Added a critical security warning to `README.md` regarding the risks of remote shell access.
- **Rate Limiting:** Implemented `max_buffer_size` in `AsyncDebouncer` and message trimming in `OutputRouter` to prevent memory exhaustion and Telegram API flooding.

### 2. External Output Streaming (`--output-stream`)
- **Design Pivot:** Decided to bypass TUI screen-scraping complexity in favor of tailing a clean log file generated by the child application.
- **Implementation:** Created the `FileTailer` component with support for asynchronous reading, file rotation, and truncation handling.
- **CLI Integration:** Added the `-o` / `--output-stream` flag to `cli.py`.
- **PTY Draining:** Refactored `OutputRouter` to always drain the PTY in a background task, preventing child processes from blocking when their stdout buffers fill up.

### 3. Terminal Experience & TUI Mirroring
- **Key Shortcuts:** Implemented a robust parser for terminal shortcuts and modifier combinations (`/enter`, `/c a`, `/c /s a`, `/up`, etc.). Refined the syntax to use spaces between modifiers and keys for better Telegram command parsing.
- **Local Mirroring:** Enabled mirroring of the PTY output to the local terminal, allowing the user to see the TUI while interacting via Telegram.
- **Input Compatibility:** Switched input character from `\n` to `\r` to ensure compatibility with TUIs and interactive shells.
- **Terminal Restoration:** Implemented a robust cleanup sequence on exit:
    - Disabling mouse tracking (VT200, SGR, etc.).
    - Exiting the alternate screen buffer.
    - Clearing the screen and homing the cursor.
    - Using `termios.tcflush` with a safety delay to purge lingering mouse events from the input buffer.
- **Dynamic Resizing:** Updated the `Orchestrator` to inherit host terminal size and implemented a `SIGWINCH` handler to propagate window resizes to the child process.

### 4. Robustness & Tooling
- **Path Resolution:** Improved `Orchestrator` to automatically prepend `./` for local scripts not in `PATH`, fixing `execvp` permission errors.
- **Example App:** Built a high-quality chat-like TUI example using the `textual` library for manual testing.
- **Metadata:** Enhanced `pyproject.toml` with project descriptors, URLs, and keywords.
- **Audit Tooling:** Integrated `pip-audit` into the development workflow.

## Technical Notes
- The use of `run_in_executor` for `f.read()` and `f.readline()` proved essential for maintaining a responsive `asyncio` loop on systems with blocking file I/O behavior.
- The `tcflush` delay (0.1s) is a critical "magic" fix for terminal emulators that continue sending mouse events briefly after receiving the disable sequence.

## Next Steps
- Final review of the codebase for any remaining TUI scraping references.
- Consider adding a `--no-mirror` flag for users who want a silent local terminal.
- Prepare for the v0.2.0 release.
